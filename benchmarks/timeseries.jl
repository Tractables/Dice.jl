using Pkg; Pkg.activate(@__DIR__)
using Dice, Distributions

precision = 2
DFiP = DistFixedPoint{5+precision, precision}
num_pieces = 8
truncation = (-8.0, 8.0)
add_arg = false

xs = DFiP.([0.0530897649405518, -0.427176340746955, 0.575506045064776, -1.05503057032362, -0.00138425373659317, 0.362367184144129, -0.906400668762085, 1.39464604836768, -1.40047244298115, -0.872458836353285, -0.425555167755021, -0.192907289991263, 0.611345320709905, 0.223493915844394, -0.335855643300744, -0.786177511979181, 1.0466888412128, -1.35578280849525, -0.4802662607177, -0.482825573577857, -0.44808934155094, 1.41677018342172, -1.12722529948411, -1.52518755310289, -0.232336215009525, -0.452482201859223, -0.235580964484178, -0.789514125170731, 1.61944620303219, 0.735756130006795, -1.0253656503392, 0.936124304383727, 1.10587169595422, 0.833182124741184, 0.113696178051401, -1.15636049024915, 1.85507312756962, 1.30957252757083, 0.822235075588577, -1.43800316565635])
ys = DFiP.([-1.09070023335653, -2.49513228748069, -2.07918898737732, -3.34621083464711, -3.21905761756761, -3.84835139936697, -4.14591579938845, -2.17085702918779, -2.72986009710348, -2.35417403593087, -3.05798313015489, -2.85360404455837, -2.9261492993768, -2.67713444957349, -2.97731974867721, -4.7510500052692, -3.2939903406896, -4.11626048191435, -4.08086402479665, -3.34743297842617, -3.59294970060833, -1.70489370379594, -3.522911840642, -4.13944648650588, -4.04992280586435, -3.71707285571859, -2.6830205191276, -3.21920265745786, -1.78221835462429, -1.71385611701893, -3.15284681754168, -3.26094915407183, -2.92240028325557, -2.40186352631743, -3.1697331801915, -4.00540748111558, -2.32625323220302, -1.74827635320394, -1.05716214917384, -3.44536781268663])

code = @dice begin
  
  alpha = uniform(DFiP, -4.0, 4.0)
  beta = uniform(DFiP, -4.0, 4.0)
  lambda = uniform(DFiP, 0.0, 1.0)
  y_prev = ys[1]

  for (x, y) in zip(xs[2:40], ys[2:40])
    mean = alpha + beta * x + lambda * y_prev
    gaussian_observe(DFiP, num_pieces, truncation[1], truncation[2], mean, 0.5, y, add=add_arg)
    y_prev = y
  end
  alpha
end

@time expectation(code)